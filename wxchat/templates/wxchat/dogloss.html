{% extends 'wxchat/wxbase.html' %}{% load static %}

{% block tabpanel %}
        <div class="weui-tab__content" id="tab1">
            <div class="weui-panel weui-panel_access">
                <div class="weui-panel__hd">
                    	<div class="weui-flex">
                            <div class="weui-flex__item"><span class="title">寻找宠物列表<span></div>
                            <div class="weui-flex__item"><a href="{% url 'dog-loss-add' %}?next={{ request.get_full_path }}" class="weui-btn weui-btn_mini weui-btn_primary r">寻宠发布</a></div>
                        </div>
                </div>
                <div class="weui-panel__bd" id="dogloss"></div>
                <div class="weui-panel__ft">
                    <a href="javascript:void(0);" class="weui-cell weui-cell_access weui-cell_link" id="doglossmore" style="display: none">
                        <div class="weui-cell__bd">查看更多</div>
                        <span class="weui-cell__ft"></span>
                    </a>
                </div>
            </div>
        </div>
        <div class="weui-tab__content" id="tab2">
            <div class="weui-panel weui-panel_access">
                <div class="weui-panel__hd">
                    <div class="weui-flex">
                            <div class="weui-flex__item"><span class="title">寻找宠物主人列表<span></div>
                            <div class="weui-flex__item"><a href="{% url 'dog-owner-add' %}?next={{ request.get_full_path }}" class="weui-btn weui-btn_mini weui-btn_primary r" >寻主发布</a></div>
                    </div>
                </div>
                <div class="weui-panel__bd" id="dogowner"></div>
                <div class="weui-panel__ft" >
                    <a href="javascript:void(0);" class="weui-cell weui-cell_access weui-cell_link" id="dogownermore" style="display: none">
                        <div class="weui-cell__bd">查看更多</div>
                        <span class="weui-cell__ft"></span>
                    </a>
                </div>
            </div>
        </div>
{% endblock tabpanel %}
 {% block tabbar %}
        <a href="#tab1" class="weui-tabbar__item">
            <div class="weui-tabbar__icon">'
                <img src="{% static 'wxchat/images/icon_nav_button.png' %}" alt="">
            </div>
            <p class="weui-tabbar__label">寻宠物</p>
        </a>
        <a href="#tab2" class="weui-tabbar__item">
            <div class="weui-tabbar__icon">
                <img src="{% static 'wxchat/images/icon_nav_msg.png' %}" alt="">
            </div>
            <p class="weui-tabbar__label">寻宠主</p>
        </a>

{% endblock tabbar %}
{% block bottomjs %}
    {{ block.super }}
    <script type="application/javascript">
     nextUrl = '{% url 'dog-loss-list' %}';
     dogOwnerUrl = '{% url 'dog-owner-list' %}';

    $(function(){
        defIndex = 0;
        param = location.search;
        if (param.indexOf("=") != -1) {
            strs = param.split("=");
            defIndex = strs[1];
        }
        weui.tab('#tab',{
            defaultIndex: defIndex,
            onChange: function(index){
{#                console.log(index);#}
        }
    });

        $('#doglossmore').on('click',function(){
            getDataList( nextUrl );
        });

        $('#dogownermore').on('click',function(){
            getDogOwnerList( dogOwnerUrl );
        });
        getDataList( nextUrl );
        getDogOwnerList(dogOwnerUrl);
    });
    function getDataList(url){
        $.ajax({
          type: 'GET',
          url: url,
          dataType: 'json',
          timeout: 500,
          context: $('#dogloss'),
          success: function(data){
              nextUrl = data.next;
              appendItem(data.results);
              $('#doglossmore').css('display','');
          },
          error: function(xhr, type,error){
              console.log(type);
          }
        });
    }

    function appendItem(results){
        $.each(results,function(index,item){
            var img_url = item.picture;
            if(img_url == null){
                img_url = "{% static 'wxchat/images/default_dog.png' %}";
            }
          lossitem =  '<a href="/wechat/doglossdetail/' + item.id + '" class="weui-media-box weui-media-box_appmsg">' +
                            '<div class="weui-media-box__hd"><img class="weui-media-box__thumb" src="' + img_url + '" ></div>'+
                            '<div class="weui-media-box__bd">' +
                               '<h4 class="weui-media-box__title">'+ item.dog_name +'</h4>' +
                               '<ul class="weui-media-box__info">' +
								  '<li class="weui-media-box__info__meta">' + item.typename + '</li>' +
								  '<li class="weui-media-box__info__meta weui-media-box__info__meta_extra">' + item.colors +'</li>' +
								  '<li class="weui-media-box__info__meta weui-media-box__info__meta_extra">' + item.lostdate +'</li>' +
								'</ul>' +
                               '<p class="weui-media-box__desc">地点:'+ item.lostplace +'</p>'  +
                             '</div>' +
                        '</a>';
            $('#dogloss').append( lossitem );
        }) ;
    }

    function getDogOwnerList(url){
        $.ajax({
          type: 'GET',
          url: url,
          dataType: 'json',
          timeout: 500,
          context: $('#dogowner'),
          success: function(data){
              dogOwnerUrl = data.next;
              appendDogOwnerItem(data.results);
              $('#dogownermore').css('display','');
          },
          error: function(xhr, type,error){
              console.log(type);
          }
        });
    }

    function appendDogOwnerItem(results){
        $.each(results,function(index,item){
            var img_url = item.picture;
            if(img_url == null){
                img_url = "{% static 'wxchat/images/default_dog.png' %}";
            }
          lossitem =  '<a  href="/wechat/dogownerdetail/' + item.id + '" class="weui-media-box weui-media-box_appmsg">' +
                            '<div class="weui-media-box__hd"><img class="weui-media-box__thumb" src="' + img_url + '" ></div>'+
                            '<div class="weui-media-box__bd">' +
                               '<h4 class="weui-media-box__title">品种:'+ item.typename +'</h4>' +
                               '<ul class="weui-media-box__info">' +
								  '<li class="weui-media-box__info__meta">颜色:' + item.colors + '</li>' +
								  '<li class="weui-media-box__info__meta weui-media-box__info__meta_extra">时间:' + item.finddate +'</li>' +
								'</ul>' +
                               '<p class="weui-media-box__desc">地点:'+ item.findplace +'</p>'  +
                             '</div>' +
                        '</a>';
            $('#dogowner').append( lossitem );
        }) ;
    }

    </script>
{% endblock bottomjs %}
