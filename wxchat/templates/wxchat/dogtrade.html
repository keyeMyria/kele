{% extends 'wxchat/wxbase.html' %}{% load static %}

{% block tabpanel %}
{#      <div class="weui-flex">#}
{#        <div class="weui-flex__item" style="text-align: center;padding-top: 10px;"><a href="{% url 'dog-sale-add' %}?next={{ request.get_full_path }}" class="weui-btn weui-btn_mini weui-btn_plain-primary" >出售发布</a></div>#}
{#        <div class="weui-flex__item" style="text-align: center;padding-top: 10px;"><a href="{% url 'dog-buy-add' %}?next={{ request.get_full_path }}" class="weui-btn weui-btn_mini weui-btn_plain-primary">求购发布</a></div>#}
{#      </div>#}
        <div class="weui-tab__content" id="tab1">
            <div class="weui-panel weui-panel_access">
                <div class="weui-panel__hd">
                    <div class="weui-flex">
                            <div class="weui-flex__item"><span class="title">宠物出售信息</span></div>
                            <div class="weui-flex__item"></div>
                            <div class="weui-flex__item"><a href="{% url 'dog-index' %}?next={{ request.get_full_path }}"><i class="fa fa-home fa-2x pink r" ></i></a></div>
                     </div>
                </div>
                <div class="weui-panel__bd" id="dogsale"></div>
                <div class="weui-panel__ft" >
                    <a href="javascript:void(0);" class="weui-cell weui-cell_access weui-cell_link" id="dogsalemore" style="display: none">
                        <div class="weui-cell__bd">查看更多</div>
                        <span class="weui-cell__ft"></span>
                    </a>
                </div>
            </div>
        </div>
        <div class="weui-tab__content" id="tab2">
            <div class="weui-panel weui-panel_access">
                <div class="weui-panel__hd">
                     <div class="weui-flex">
                            <div class="weui-flex__item"><span class="title">宠物求购信息</span></div>
                            <div class="weui-flex__item"></div>
                            <div class="weui-flex__item"><a href="{% url 'dog-index' %}?next={{ request.get_full_path }}"><i class="fa fa-home fa-2x pink r" ></i></a></div>
                     </div>
                </div>
                <div class="weui-panel__bd" id="dogbuy">

                </div>
                <div class="weui-panel__ft">
                    <a href="javascript:void(0);" class="weui-cell weui-cell_access weui-cell_link" id="dogbuymore" style="display: none">
                        <div class="weui-cell__bd">查看更多</div>
                        <span class="weui-cell__ft"></span>
                    </a>
                </div>
            </div>
        </div>

{% endblock tabpanel %}
 {% block tabbar %}
        <a href="#tab1" class="weui-tabbar__item">
            <div class="weui-tabbar__icon">'
                <i class="fa fa-database" aria-hidden="true"></i>
            </div>
            <p class="weui-tabbar__label">宠物出售</p>
        </a>
        <a href="#tab2" class="weui-tabbar__item">
            <div class="weui-tabbar__icon">
                <i class="fa fa-shopping-cart" aria-hidden="true"></i>
            </div>
            <p class="weui-tabbar__label">宠物求购</p>
        </a>

{% endblock tabbar %}
{% block add %}
      <div class="circle">
          <a href="{% url 'dog-sale-add' %}?next={{ request.get_full_path }}"><i class="fa fa-plus-circle fa-3x" aria-hidden="true"></i></a>
      </div>
{% endblock add %}
{% block bottomjs %}
    {{ block.super }}
    <script type="application/javascript">
        nextBuyUrl = '{% url 'dog-buy-list' %}';
        nextSaleUrl = '{% url 'dog-sale-list' %}';
        var loading = weui.loading('加载中...');
        ///缓存滚动条位置
         $('.weui-tab__panel').scroll(function(){
                if($(this).scrollTop() !=0 ){
                    sessionStorage.setItem('offsetTop',$(this).scrollTop());
                }
        });

        $(function(){
            defIndex = sessionStorage.getItem('tab');
            weui.tab('#tab',{
                defaultIndex: defIndex ==null?0:defIndex,
                onChange: function(index){
                    sessionStorage.setItem('tab',index);
                }
            });

         $('#dogbuymore').on('click',function(){
            getBuyList( nextBuyUrl );
         });
         $('#dogsalemore').on('click',function(){
            getSaleList( nextSaleUrl );
         });
         getBuyList(nextBuyUrl);
         getSaleList(nextSaleUrl);

        })

    function getBuyList(url) {
        $.ajax({
          type: 'GET',
          url: url,
          dataType: 'json',
          timeout: 5000,
          context: $('#dogbuy'),
          success: function(data){
              nextBuyUrl = data.next;
              appendBuyItem(data.results);
              if(nextBuyUrl == null)
                $('#dogbuymore').css('display','none');
              else
                 $('#dogbuymore').css('display','');
              loading.hide();
              setScollPos();
          },
          error: function(xhr, type,error){
              loading.hide();
          }
        });
    }

    function getSaleList(url){
        $.ajax({
          type: 'GET',
          url: url,
          dataType: 'json',
          timeout: 5000,
          context: $('#dogsale'),
          success: function(data){
              nextSaleUrl = data.next;
              appendSaleItem(data.results);
              if(nextSaleUrl == null)
                $('#dogsalemore').css('display','none');
              else
                 $('#dogsalemore').css('display','');
              setScollPos();
          },
          error: function(xhr, type,error){
          }
        });

    }

    function appendBuyItem(results){
        $.each(results,function(index,item){
          var sexImage = getSexImage(item);
          buyitem ='<div class="weui-media-box weui-media-box_text">' +
                        '<a href="/wechat/dogbuydetail/' + item.id + '">' +
                        '<h4 class="weui-media-box__title">'+ sexImage  + item.typeid + '</h4>' +
                        '<p class="weui-media-box__desc">价格: '+ item.price +'</p>'  +
                        '</a>' +
                     '</div>' ;
            $('#dogbuy').append( buyitem );
        }) ;
    }

    function appendSaleItem(results){
        $.each(results,function(index,item){
            var img_url = item.picture;
            if(img_url == null){
                img_url = "{% static 'wxchat/images/default_dog.png' %}";
            }
            var age = item.ages;
            if( age != null )
                age = '【' + age + '】'

            var setImage = getSexImage(item);
            saleitem =  '<a  href="/wechat/dogsaledetail/' + item.id + '" class="weui-media-box weui-media-box_appmsg">' +
                            '<div class="weui-media-box__hd"><img class="weui-media-box__thumb" src="' + img_url + '" ></div>'+
                            '<div class="weui-media-box__bd">' +
                               '<h4 class="weui-media-box__title">'+ setImage + item.typeid + age +'</h4>' +
                               '<ul class="weui-media-box__info">' +
								  '<li class="weui-media-box__info__meta">价格 : ' + item.price +'</li>' +
								'</ul>' +
                               '<p class="weui-media-box__desc">说明 : '+ item.desc +'</p>'  +
                             '</div>' +
                        '</a>';
            $('#dogsale').append( saleitem );
        }) ;
    }

    ////设置滚动条位置
    function setScollPos(){
        var _offset = sessionStorage.getItem("offsetTop");//获取滚动位置
        $('.weui-tab__panel').scrollTop(_offset);
    }

    </script>
{% endblock bottomjs %}
